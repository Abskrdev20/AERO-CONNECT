<% layout('layouts/boilerplate') -%>

<%
  if (typeof isAdmin === "undefined") {
    isAdmin = false;
  }
%>

<link rel="stylesheet" href="/css/dashboard.css">

<div class="dashboard-container">
  <main class="main-content" style="margin-left:260px; padding:30px">

    <h2 class="mb-3">Grievance Details</h2>

    <div class="card p-4 shadow-sm">

      <!-- ================= BASIC INFO ================= -->
      <p><strong>Grievance ID:</strong> <%= grievance.grievanceId %></p>
      <p><strong>Status:</strong> <%= grievance.status.replace("_", " ") %></p>
      <p><strong>Category:</strong> <%= grievance.category %></p>
      <p><strong>Priority:</strong> <%= grievance.priority.toUpperCase() %></p>
      <p><strong>Submitted On:</strong>
        <%= new Date(grievance.createdAt).toLocaleString("en-IN") %>
      </p>

      <% if (grievance.reviewedAt) { %>
        <p>
          <strong>Reviewed At:</strong>
          <%= new Date(grievance.reviewedAt).toLocaleString("en-IN") %>
        </p>
      <% } %>

      <% if (grievance.resolvedAt) { %>
        <p>
          <strong>Resolved At:</strong>
          <%= new Date(grievance.resolvedAt).toLocaleString("en-IN") %>
        </p>
      <% } %>

      <hr>

      <!-- ================= COMPLAINANT DETAILS ================= -->
      <h5>Complainant Details</h5>
      <p><strong>Name:</strong> <%= grievance.user.fullName %></p>
      <p><strong>Employee ID:</strong> <%= grievance.user.employeeId %></p>
      <p><strong>Email:</strong> <%= grievance.user.email %></p>
      <p><strong>Department:</strong> <%= grievance.user.department %></p>
      <p><strong>Designation:</strong>
        <%= grievance.user && grievance.user.position
              ? grievance.user.position.replace(/_/g, " ")
              : "N/A" %>
      </p>

      <hr>

      <!-- ================= GRIEVANCE CONTENT ================= -->
      <h5>Subject</h5>
      <p><%= grievance.subject %></p>

      <h5>Description</h5>
      <div class="border p-3 rounded bg-light">
        <%- grievance.description %>
      </div>

      <hr>

      <!-- ================= INCIDENT DETAILS ================= -->
      <h5>Incident Details</h5>
      <p><strong>Date:</strong> <%= grievance.incidentDate ? new Date(grievance.incidentDate).toLocaleDateString("en-IN") : "N/A" %></p>
      <p><strong>Time:</strong> <%= grievance.incidentTime || "N/A" %></p>
      <p><strong>Location:</strong> <%= grievance.location || "N/A" %></p>

      <hr>

      <!-- ================= ATTACHMENTS ================= -->
      <h5>Attachments</h5>
      <% if (!grievance.attachments || grievance.attachments.length === 0) { %>
        <p class="text-muted">No attachments uploaded.</p>
      <% } else { %>
        <div class="d-flex flex-wrap gap-3">
          <% grievance.attachments.forEach(file => { %>
            <% if (file.resource_type === "image") { %>
              <a href="<%= file.url %>" target="_blank">
                <img
                  src="<%= file.url %>"
                  style="width:150px;height:150px;object-fit:cover;border-radius:6px;border:1px solid #ddd;">
              </a>
            <% } else { %>
              <a
                href="<%= file.url %>"
                target="_blank"
                class="btn btn-outline-primary btn-sm">
                üìÑ View Document
              </a>
            <% } %>
          <% }) %>
        </div>
      <% } %>

      <!-- ================= INTERNAL TRANSFER NOTE ================= -->
      <% if (grievance.forwardingRemark) { %>
        <hr>
        <h5>Internal Transfer Note</h5>
        <div class="alert alert-warning">
          <i class="fas fa-info-circle me-2"></i>
          <%= grievance.forwardingRemark %>
        </div>
      <% } %>

      <!-- ================= DEPARTMENT RESPONSE ================= -->
      <% if (grievance.departmentComment) { %>
        <hr>
        <h5>Official Department Response</h5>
        <div class="alert alert-success">
          <%= grievance.departmentComment %>
        </div>
      <% } %>

      <% if (isAdmin && (grievance.status === 'OPEN' || grievance.status === 'UNDER_REVIEW')) { %>
        <hr>
        <!-- ============= FORWARD SECTION ============= -->
        <div class="mt-4 p-3 border rounded" style="background-color: #fffaf0; border-color: #ffeeba !important;">
          <h5 class="text-warning"><i class="fas fa-share-square"></i> Forward to Another Department</h5>
          <p class="small text-muted">If this grievance does not pertain to your department, please forward it to the concerned department.</p>
          
          <form action="/admin/grievances/<%= grievance.grievanceId %>/forward" method="POST">
            <div class="mb-3">
              <label class="form-label fw-bold small">Choose Correct Department:</label>
              <select name="newCategory" class="form-select" required>
                <option value="" disabled selected>Select Department...</option>
                <option value="Operations">Operations</option>
                <option value="IT">IT</option>
                <option value="ATM">ATM</option>
                <option value="HR">HR</option>
                <option value="Finance">Finance</option>
                <option value="Security">Security</option>
                <option value="Engg. Civil">Engg. Civil</option>
                <option value="Engg. Electrical">Engg. Electrical</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold small">Reason for Redirection (Remark):</label>
              <textarea name="remark" class="form-control" rows="2" placeholder="Write why you are redirecting this..." required></textarea>
            </div>
            <button type="submit" class="btn btn-warning w-100 fw-bold">Forward to Department</button>
          </form>
        </div>

        <hr>
        <!-- ============= ACTION SECTION ============= -->
        <h5>Department Action</h5>

        <form
          method="POST"
          action="/admin/grievances/<%= grievance.grievanceId %>/action">

          <div class="mb-3">
            <label class="form-label">Update Official Remark</label>
            <textarea
              name="remark"
              class="form-control"
              rows="4"
              placeholder="Enter resolution or update note..."
              required
            ><%= grievance.departmentComment || "" %></textarea>
          </div>

          <button class="btn btn-primary">
            <% if (grievance.status === "OPEN") { %>
              Mark as Under Review
            <% } else { %>
              Resolve Grievance
            <% } %>
          </button>
        </form>
      <% } %>

      <div class="mt-4">
        <a
          href="<%= isAdmin ? '/admin/dashboard' : '/dashboard' %>"
          class="btn btn-secondary">
          ‚Üê Back
        </a>
      </div>

    </div>
  </main>
</div>