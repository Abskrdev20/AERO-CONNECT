<% layout('layouts/boilerplate') -%>

<link rel="stylesheet" href="/css/super-admin.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --sa-primary: #003d82;
        --sa-secondary: #1e40af;
        --sa-accent: #3b82f6;
        --sa-success: #28c76f;
        --sa-danger: #ef4444;
        --sa-warning: #ff9f43;
        --sa-border: #e2e8f0;
        --text-main: #1e293b;
        --text-light: #64748b;
        --sa-light-blue: #f0f7ff;
    }

    /* Analytics Control */
    .sa-analytics-control {
        background: #fff;
        padding: 20px 25px;
        border-radius: 16px;
        border: 1px solid var(--sa-border);
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }

    /* Stats Grid Fix for Borders */
    .sa-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 35px;
    }

    .sa-stat-card {
        background: #fff;
        padding: 22px;
        border-radius: 14px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.04);
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: all 0.3s ease;
        border: 1px solid var(--sa-border);
        border-left: 6px solid transparent; 
        border-top: 5px solid transparent; 
        position: relative;
        overflow: hidden;
    }
    
    .sa-stat-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.07); }
    .sa-stat-card .label { color: var(--text-light); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; }
    .sa-stat-card .value { font-size: 2.4rem; font-weight: 800; color: var(--sa-primary); line-height: 1; }

    /* Layout Spacing */
    .sa-charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin-bottom: 30px; }
    .full-column { grid-column: 1 / -1; }

    .sa-card {
        background: #fff;
        padding: 28px;
        border-radius: 20px;
        border: 1px solid var(--sa-border);
        box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    }

    /* Left Aligned Headers with Right Elements */
    .sa-card-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 25px;
        font-weight: 700;
        color: var(--sa-primary);
    }

    .title-left-group { 
        display: flex; 
        align-items: center; 
        gap: 12px; 
        text-align: left; 
    }
    .sa-card-title i { font-size: 1.25rem; }

    /* Insight Badges */
    .insight-badge {
        background: var(--sa-light-blue);
        color: var(--sa-primary);
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Modern Toggle Switch */
    .switch { position: relative; display: inline-block; width: 48px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--sa-danger); }
    input:checked + .slider:before { transform: translateX(24px); }

    /* Button Styling */
    .btn-provision-admin {
        background-color: var(--sa-primary);
        color: white !important;
        border: none;
        padding: 10px 24px;
        border-radius: 50px;
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(0, 61, 130, 0.2);
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-provision-admin:hover {
        background-color: var(--sa-secondary);
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 61, 130, 0.3);
    }

    .sa-btn-export {
        color: var(--sa-primary);
        border: 2px solid var(--sa-primary);
        background: transparent;
        padding: 8px 18px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.85rem;
        transition: all 0.2s;
    }
    .sa-btn-export:hover {
        background: var(--sa-primary);
        color: white;
    }

    @media (max-width: 1100px) { .sa-charts-grid { grid-template-columns: 1fr; } .full-column { grid-column: auto; } }
</style>

<div class="sa-container">
    <aside class="sa-sidebar">
        <div class="sa-profile">
            <div class="sa-avatar">SA</div>
            <h6 class="m-0 text-black">System Admin</h6>
            <small style="font-size: 0.85rem; font-weight: 600; color: var(--sa-primary);">AAI Command Center</small>
        </div>
        <nav class="sa-nav">
            <div class="sa-nav-item active" onclick="switchSection('intelligence', this)">
                <i class="fas fa-chart-line"></i> <span>Global Intelligence</span>
            </div>
            <div class="sa-nav-item" onclick="switchSection('accounts', this)">
                <i class="fas fa-users-cog"></i> <span>Accounts Control</span>
            </div>
            <div class="sa-nav-item" onclick="switchSection('audit', this)">
                <i class="fas fa-clipboard-list"></i> <span>Audit Trail</span>
            </div>
            <div class="sa-nav-divider"></div>
            <a href="/admin/create-department" class="sa-nav-item" style="text-decoration: none;">
                <i class="fas fa-user-plus"></i> <span>Add Account</span>
            </a>
            <a href="/logout" class="sa-nav-item sa-nav-logout" style="text-decoration: none;">
                <i class="fas fa-power-off"></i> <span>Logout</span>
            </a>
        </nav>
    </aside>

    <main class="sa-main">
        <div id="intelligence" class="dashboard-section active">
            <header class="sa-header">
                <div class="sa-header-left">
                    <h1 style="color: var(--sa-primary);">Operational Intelligence</h1>
                    <p>Strategic oversight for AAI grievance network.</p>
                </div>
                <div class="sa-header-right">
                    <span class="badge bg-success border-0 px-4 py-2 rounded-pill shadow-sm d-inline-flex align-items-center gap-2" style="font-size: 0.75rem;">
                        <span class="spinner-grow spinner-grow-sm"></span>SYSTEM ACTIVE
                    </span>
                </div>
            </header>

            <div class="sa-ticker-container" style="background: var(--sa-primary);">
                <div class="ticker-wrapper">
                    <% for(let i = 0; i < 2; i++) { grievances.slice(0, 10).forEach(g => { %>
                        <span class="ticker-item">
                            <i class="fas fa-broadcast-tower me-2"></i>
                            ID: <b><%= g.grievanceId %></b> | STATE: <b><%= g.status %></b>
                        </span>
                    <% }); } %>
                </div>
            </div>

            <div class="sa-analytics-control">
                <h5 class="m-0 fw-bold"><i class="fas fa-chart-simple me-2 text-primary"></i>Dashboard Insights</h5>
                <div class="d-flex align-items-center gap-3">
                    <span class="fw-bold text-danger" style="font-size: 0.85rem;">Escalated Alerts Context</span>
                    <label class="switch">
                        <input type="checkbox" id="escalatedToggle" onchange="updateDashboardView()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="sa-stats-grid">
                <% 
                   const statsData = [
                       { id: 'statTotal', label: 'Gross Records', value: stats.total, color: 'var(--sa-primary)' },
                       { id: 'statResolved', label: 'Verified Success', value: stats.resolved, color: 'var(--sa-success)' },
                       { id: 'statPending', label: 'Active Workflows', value: stats.pending, color: 'var(--sa-warning)' },
                       { id: 'statEscalated', label: 'Breach Alerts', value: stats.escalated, color: 'var(--sa-danger)' }
                   ];
                   statsData.forEach(item => { 
                %>
                    <div class="sa-stat-card" style="border-left-color: <%= item.color %> !important; border-top-color: <%= item.color %> !important;">
                        <span class="label"><%= item.label %></span>
                        <span class="value" id="<%= item.id %>"><%= item.value %></span>
                    </div>
                <% }); %>
            </div>

            <div class="sa-card mb-4" style="border-top: 5px solid #dc3545;">
                <div class="sa-card-title text-danger">
                    <span><i class="fas fa-clock me-2"></i>SLA Breach Alerts (>20 Days)</span>
                </div>
                
                <div class="sa-table-wrapper">
                    <table class="sa-table">
                        <thead>
                            <tr>
                                <th>Grievance ID</th>
                                <th>Dept</th>
                                <th>Days Pending</th>
                                <th>System Reason</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% const escalated = grievances.filter(g => g.isEscalated && g.status !== 'RESOLVED'); %>
                            
                            <% if(escalated.length > 0) { %>
                                <% escalated.forEach(g => { 
                                   // Calculate Days Open
                                   const daysOld = Math.floor((new Date() - new Date(g.createdAt)) / (1000 * 60 * 60 * 24));
                                %>
                                <tr style="background-color: #fff5f5;">
                                    <td><b><%= g.grievanceId %></b></td>
                                    <td><%= g.category %></td>
                                    <td class="text-danger fw-bold"><%= daysOld %> Days</td>
                                    <td class="text-muted small"><%= g.escalationReason %></td>
                                    <td>
                                        <form action="/admin/resolve-escalation/<%= g._id %>" method="POST" class="d-flex gap-2">
                                            <input type="text" name="comment" class="form-control form-control-sm" placeholder="Resolution Note..." required>
                                            <button type="submit" class="sa-btn-view" style="background:#27ae60; color:white; border:none;">
                                                Resolve
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                <% }) %>
                            <% } else { %>
                                <tr><td colspan="5" class="text-center text-muted p-3">No SLA breaches detected.</td></tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="chartContainer" class="sa-charts-grid">
                <div class="sa-card">
                    <div class="sa-card-title">
                        <div class="title-left-group"><i class="fas fa-chart-pie"></i><span>Sector Workload Distribution</span></div>
                        <span class="insight-badge">By Dept</span>
                    </div>
                    <div class="chart-container" style="height: 260px;"><canvas id="loadChart"></canvas></div>
                </div>

                <div class="sa-card">
                    <div class="sa-card-title">
                        <div class="title-left-group"><i class="fas fa-tasks"></i><span>Protocol State Distribution</span></div>
                        <span class="insight-badge">By Status</span>
                    </div>
                    <div class="chart-container" style="height: 260px;"><canvas id="statusChart"></canvas></div>
                </div>
                
                <div class="sa-card full-column">
                    <div class="sa-card-title">
                        <div class="title-left-group"><i class="fas fa-chart-line"></i><span>Recent Submission Trend (Last 7 Days)</span></div>
                        <span class="insight-badge">Live Analytics</span>
                    </div>
                    <div class="chart-container" style="height: 320px;"><canvas id="trendChart"></canvas></div>
                </div>

                <div class="sa-card full-column">
                    <div class="sa-card-title">
                        <div class="title-left-group"><i class="fas fa-chart-bar"></i><span>Sector Performance Matrix</span></div>
                        <span class="insight-badge">Resolution Efficiency</span>
                    </div>
                    <div class="chart-container" style="height: 380px;"><canvas id="performanceChart"></canvas></div>
                </div>
            </div>

            <div class="sa-card mb-4">
                <div class="sa-card-title">
                    <div class="title-left-group"><span>Master Grievance Registry Log</span></div>
                    <button class="sa-btn-export shadow-sm" onclick="exportToExcel()">
                        <i class="fas fa-file-export me-2"></i>Export Registry
                    </button>
                </div>
                <div class="sa-table-wrapper">
                    <table class="sa-table" id="registryTable">
                        <thead>
                            <tr>
                                <th>Registry ID</th>
                                <th>Sector</th>
                                <th class="text-center">Submission Date</th>
                                <th class="text-center">Current State</th>
                                <th class="text-end">Log Access</th>
                            </tr>
                        </thead>
                        <tbody id="grievanceTableBody">
                            <% grievances.forEach(g => { %>
                                <tr class="grievance-row" data-escalated="<%= g.isEscalated %>">
                                    <td class="fw-bold"><%= g.grievanceId %> <% if(g.isEscalated) { %><i class="fas fa-bolt text-danger ms-1"></i><% } %></td>
                                    <td><%= g.category %></td>
                                    <td class="text-center"><%= new Date(g.createdAt).toLocaleDateString('en-IN') %></td>
                                    <td class="text-center">
                                        <span class="sa-badge <%= g.status.toLowerCase().replace('_', '-') %>"><%= g.status.replace('_', ' ') %></span>
                                    </td>
                                    <td class="text-end"><a href="/admin/grievances/<%= g.grievanceId %>" class="sa-btn-view"><i class="fas fa-eye"></i> View</a></td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="accounts" class="dashboard-section">
            <header class="sa-header">
                <div class="sa-header-left"><h1>Identity & Access Control</h1></div>
                <div class="sa-header-right">
                    <a href="/admin/create-department" class="btn-provision-admin">
                        <i class="fas fa-user-plus"></i>Provision New Admin
                    </a>
                </div>
            </header>
            <div class="sa-card">
                <div class="sa-card-title">Active Administrator Directory</div>
                <div class="sa-table-wrapper">
                    <table class="sa-table">
                        <thead>
                            <tr><th>Name</th><th>Email</th><th class="text-center">Role</th><th class="text-end">Action</th></tr>
                        </thead>
                        <tbody>
                            <% if (typeof departments !== 'undefined' && departments && departments.length > 0) { %>
                                <% departments.forEach(dept => { %>
                                    <tr>
                                        <td class="fw-bold text-primary"><%= dept.name %></td>
                                        <td><%= dept.email %></td>
                                        <td class="text-center"><span class="badge <%= dept.role === 'SUPERADMIN' ? 'bg-danger' : 'bg-primary' %>"><%= dept.role %></span></td>
                                        <td class="text-end">
                                            <form action="/admin/accounts/<%= dept._id %>/delete" method="POST" onsubmit="return confirm('Account permanently delete karein?')">
                                                <button class="btn btn-sm btn-light border text-danger"><i class="fas fa-trash-alt"></i></button>
                                            </form>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="5" class="text-center text-muted p-4">No accounts detected in database.</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="audit" class="dashboard-section">
            <header class="sa-header"><h1>System Audit Trail</h1></header>
            <div class="sa-card">
                <div class="sa-card-title">Operational Event Ledger</div>
                <div class="audit-list">
                    <% grievances.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt)).slice(0, 15).forEach(g => { %>
                        <div class="audit-item border-bottom py-3 d-flex gap-3">
                            <i class="fas fa-fingerprint text-primary mt-1"></i>
                            <div>
                                <h6 class="m-0 fw-bold">Registry Update: <%= g.grievanceId %></h6>
                                <p class="small text-muted mb-1">State transitioned to <b><%= g.status %></b></p>
                                <small class="text-muted text-uppercase" style="font-size: 10px;"><%= new Date(g.updatedAt).toLocaleString() %></small>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    let activeCharts = {};
    const rawGrievances = <%- JSON.stringify(grievances) %>;

    function switchSection(id, btn) {
        document.querySelectorAll('.dashboard-section, .sa-nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function updateDashboardView() {
        const isEscalatedOnly = document.getElementById('escalatedToggle').checked;
        document.querySelectorAll('.grievance-row').forEach(row => {
            const isEsc = row.getAttribute('data-escalated') === 'true';
            row.style.display = (isEscalatedOnly && !isEsc) ? 'none' : '';
        });

        const filtered = isEscalatedOnly ? rawGrievances.filter(g => g.isEscalated) : rawGrievances;
        
        document.getElementById('statTotal').innerText = filtered.length;
        document.getElementById('statResolved').innerText = filtered.filter(g => g.status === 'RESOLVED').length;
        document.getElementById('statPending').innerText = filtered.filter(g => ['OPEN', 'UNDER_REVIEW'].includes(g.status)).length;
        document.getElementById('statEscalated').innerText = rawGrievances.filter(g => g.isEscalated).length;
        
        initCharts(filtered);
    }

    function getTrendData(data) {
        const labels = [], counts = [];
        for (let i = 6; i >= 0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i);
            const ds = d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
            labels.push(ds);
            counts.push(data.filter(g => new Date(g.createdAt).toDateString() === d.toDateString()).length);
        }
        return { labels, counts };
    }

    function initCharts(data = rawGrievances) {
        Object.values(activeCharts).forEach(c => c.destroy());

        const baseOpts = { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: '600', size: 10 }, padding: 15 } } 
            } 
        };
        const categories = [...new Set(data.map(g => g.category))];

        // Professional Qualitative Palette (Non-Blue Monotone)
        const qualitativePalette = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#8b5cf6', '#475569'];

        // 1. Sector Workload - Vibrant Qualitative Colors
        activeCharts.load = new Chart(document.getElementById('loadChart'), {
            type: 'doughnut',
            data: { 
                labels: categories, 
                datasets: [{ 
                    data: categories.map(c => data.filter(g => g.category === c).length), 
                    backgroundColor: qualitativePalette, 
                    borderWidth: 2, borderColor: '#fff'
                }] 
            },
            options: { ...baseOpts, cutout: '78%' }
        });

        // 2. Protocol State - Semantic Colors
        activeCharts.status = new Chart(document.getElementById('statusChart'), {
            type: 'pie',
            data: { 
                labels: ['Open', 'Review', 'Resolved', 'Closed'], 
                datasets: [{ 
                    data: ['OPEN', 'UNDER_REVIEW', 'RESOLVED', 'CLOSED'].map(s => data.filter(g => g.status === s).length), 
                    backgroundColor: ['#f59e0b', '#6366f1', '#10b981', '#475569'], 
                    borderWidth: 2, borderColor: '#fff'
                }] 
            },
            options: baseOpts
        });

        // 3. Submission Trend - Real-time calculation
        const trend = getTrendData(data);
        activeCharts.trend = new Chart(document.getElementById('trendChart'), {
            type: 'line',
            data: { 
                labels: trend.labels, 
                datasets: [{ 
                    label: 'Records', 
                    data: trend.counts, 
                    borderColor: '#003d82', 
                    backgroundColor: 'rgba(0, 61, 130, 0.08)', 
                    fill: true, tension: 0.4, pointRadius: 5, pointBackgroundColor: '#fff', pointBorderWidth: 2
                }] 
            },
            options: { ...baseOpts, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { stepSize: 1 } } } }
        });

        // 4. Performance Matrix - Professional Dark Blue & Light Blue Contrast
        activeCharts.perf = new Chart(document.getElementById('performanceChart'), {
            type: 'bar',
            data: { 
                labels: categories, 
                datasets: [
                    { 
                        label: 'Resolved', 
                        data: categories.map(c => data.filter(g => g.category === c && g.status === 'RESOLVED').length), 
                        backgroundColor: '#93c5fd', // Light Blue for Resolved
                        borderRadius: 4, 
                        barThickness: 45 
                    }, 
                    { 
                        label: 'In Progress', 
                        data: categories.map(c => data.filter(g => g.category === c && g.status !== 'RESOLVED').length), 
                        backgroundColor: '#003d82', // Dark Blue for In Progress
                        borderRadius: 4, 
                        barThickness: 45 
                    }
                ] 
            },
            options: { ...baseOpts, scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, beginAtZero: true, grid: { color: '#f1f5f9' } } } }
        });
    }

    function exportToExcel() {
        const table = document.getElementById("registryTable");
        let csv = [];
        for (let i = 0; i < table.rows.length; i++) {
            if (table.rows[i].style.display === 'none') continue;
            let row = [], cols = table.rows[i].querySelectorAll("td, th");
            for (let j = 0; j < cols.length - 1; j++) row.push('"' + cols[j].innerText.trim().replace(/\n/g, ' ') + '"');
            csv.push(row.join(","));
        }
        const blob = new Blob([csv.join("\n")], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href = url; a.download = `AAI_Registry_${new Date().toISOString().split('T')[0]}.csv`; a.click();
    }

    document.addEventListener('DOMContentLoaded', () => initCharts());
</script>