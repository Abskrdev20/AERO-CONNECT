<% layout('layouts/boilerplate') -%>

<link rel="stylesheet" href="/css/super-admin.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* --- CORE STYLES --- */
    :root {
        --sa-primary: #003d82; --sa-secondary: #1e40af; --sa-accent: #3b82f6;
        --sa-success: #28c76f; --sa-danger: #ef4444; --sa-warning: #ff9f43;
        --sa-border: #e2e8f0; --text-main: #1e293b; --text-light: #64748b; --sa-light-blue: #f0f7ff;
    }

    /* CONTROL BAR */
    .sa-analytics-control {
        background: #fff; padding: 15px 25px; border-radius: 12px; border: 1px solid var(--sa-border);
        margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }

    /* STATS GRID */
    .sa-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .sa-stat-card {
        background: #fff; padding: 22px; border-radius: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.04);
        display: flex; flex-direction: column; gap: 8px; transition: all 0.3s ease;
        border: 1px solid var(--sa-border); border-left: 6px solid transparent; border-top: 5px solid transparent; 
        position: relative; overflow: hidden;
    }
    .sa-stat-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.07); }
    .sa-stat-card .label { color: var(--text-light); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; }
    .sa-stat-card .value { font-size: 2.2rem; font-weight: 800; color: var(--sa-primary); line-height: 1; }

    /* CHARTS LAYOUT */
    .sa-charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin-bottom: 30px; }
    .full-column { grid-column: 1 / -1; }

    /* TABLES & CARDS */
    .sa-card { background: #fff; padding: 28px; border-radius: 20px; border: 1px solid var(--sa-border); box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
    .sa-card-title { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; font-weight: 700; color: var(--sa-primary); }
    .title-left-group { display: flex; align-items: center; gap: 12px; text-align: left; }
    .sa-card-title i { font-size: 1.25rem; }
    .insight-badge { background: var(--sa-light-blue); color: var(--sa-primary); padding: 4px 12px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

    /* TOGGLE SWITCH STYLE */
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--sa-primary); }
    input:checked + .slider:before { transform: translateX(24px); }

    /* HIDDEN CLASS FOR SLA TABLE */
    .d-none-custom { display: none; }
    .d-block-custom { display: block; animation: slideDown 0.4s ease; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* BUTTONS */
    .btn-provision-admin { background-color: var(--sa-primary); color: white !important; border: none; padding: 10px 24px; border-radius: 50px; font-weight: 600; box-shadow: 0 4px 10px rgba(0, 61, 130, 0.2); transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
    .btn-provision-admin:hover { background-color: var(--sa-secondary); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 61, 130, 0.3); }
    .sa-btn-export { color: var(--sa-primary); border: 2px solid var(--sa-primary); background: transparent; padding: 8px 18px; border-radius: 50px; font-weight: 700; font-size: 0.85rem; transition: all 0.2s; }
    .sa-btn-export:hover { background: var(--sa-primary); color: white; }
    
    /* TABLE STYLES & PAGINATION */
    .grievance-row { transition: all 0.2s ease-in-out; cursor: pointer; }
    .grievance-row:hover { background-color: var(--sa-light-blue); transform: scale(1.005); box-shadow: 0 4px 15px rgba(0,0,0,0.05); z-index: 10; position: relative; border-radius: 8px; }
    
    .pagination-container { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--sa-border); }
    .pagination-btn { border: 1px solid var(--sa-border); background: white; padding: 6px 14px; border-radius: 6px; color: var(--text-main); font-size: 0.85rem; transition: all 0.2s; }
    .pagination-btn:hover:not(:disabled) { background: var(--sa-primary); color: white; border-color: var(--sa-primary); }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #f8f9fa; }

    @media (max-width: 1100px) { .sa-charts-grid { grid-template-columns: 1fr; } .full-column { grid-column: auto; } }
</style>

<div class="sa-container">
    <aside class="sa-sidebar">
        <div class="sa-profile">
            <div class="sa-avatar">SA</div>
            <h6 class="m-0 text-black">System Admin</h6>
            <small style="font-size: 0.85rem; font-weight: 600; color: var(--sa-primary);">AAI Command Center</small>
        </div>
        <nav class="sa-nav">
            <div class="sa-nav-item active" onclick="switchSection('intelligence', this)">
                <i class="fas fa-desktop"></i> <span>Command Center</span> </div>
            
            <div class="sa-nav-item" onclick="switchSection('analytics-section', this)">
                <i class="fas fa-chart-pie"></i> <span>Data Visualization</span> </div>

            <div class="sa-nav-item" onclick="switchSection('accounts', this)">
                <i class="fas fa-users-cog"></i> <span>User Management</span> </div> <div class="sa-nav-item" onclick="switchSection('audit', this)">
                <i class="fas fa-clipboard-list"></i> <span>System Logs</span> </div> <div class="sa-nav-divider"></div>
            <a href="/admin/create-department" class="sa-nav-item" style="text-decoration: none;">
                <i class="fas fa-user-plus"></i> <span>Add New Admin</span>
            </a>
            <a href="/logout" class="sa-nav-item sa-nav-logout" style="text-decoration: none;">
                <i class="fas fa-power-off"></i> <span>Logout</span>
            </a>
        </nav>
    </aside>

    <main class="sa-main">
        
        <div id="intelligence" class="dashboard-section active">
            <header class="sa-header">
                <div class="sa-header-left">
                    <h1 style="color: var(--sa-primary);">Central Command Dashboard</h1>
                    <p>Strategic oversight for AAI grievance network.</p>
                </div>
                <div class="sa-header-right">
                    <span class="badge bg-success border-0 px-4 py-2 rounded-pill shadow-sm d-inline-flex align-items-center gap-2" style="font-size: 0.75rem;">
                        <span class="spinner-grow spinner-grow-sm"></span>SYSTEM ONLINE
                    </span>
                </div>
            </header>

            <div class="sa-ticker-container" style="background: var(--sa-primary);">
                <div class="ticker-wrapper">
                    <% for(let i = 0; i < 2; i++) { grievances.slice(0, 10).forEach(g => { %>
                        <span class="ticker-item">
                            <i class="fas fa-broadcast-tower me-2"></i>
                            ID: <b><%= g.grievanceId %></b> | STATE: <b><%= g.status %></b>
                        </span>
                    <% }); } %>
                </div>
            </div>

            <div class="sa-analytics-control">
                <div>
                    <h5 class="m-0 fw-bold" style="color: var(--sa-primary);"><i class="fas fa-sliders-h me-2"></i>Dashboard Controls</h5>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="fw-bold text-danger" style="font-size: 0.85rem;">View Critical Breaches</span>
                    <label class="switch">
                        <input type="checkbox" id="slaToggle" onchange="toggleSLATable()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="sa-stats-grid">
                <% 
                   const statsData = [
                       { id: 'statTotal', label: 'Total Grievances', value: stats.total, color: 'var(--sa-primary)' },
                       { id: 'statResolved', label: 'Successfully Closed', value: stats.resolved, color: 'var(--sa-success)' },
                       { id: 'statPending', label: 'Pending Action', value: stats.pending, color: 'var(--sa-warning)' },
                       { id: 'statEscalated', label: 'SLA Breaches', value: stats.escalated, color: 'var(--sa-danger)' }
                   ];
                   statsData.forEach(item => { 
                %>
                    <div class="sa-stat-card" style="border-left-color: <%= item.color %> !important; border-top-color: <%= item.color %> !important;">
                        <span class="label"><%= item.label %></span>
                        <span class="value" id="<%= item.id %>"><%= item.value %></span>
                    </div>
                <% }); %>
            </div>

            <div id="slaTableContainer" class="sa-card mb-4 d-none-custom" style="border-top: 5px solid #dc3545; background: #fff5f5;">
                <div class="sa-card-title text-danger">
                    <span><i class="fas fa-exclamation-triangle me-2"></i>CRITICAL SLA BREACH ALERTS</span>
                </div>
                <div class="sa-table-wrapper">
                    <table class="sa-table">
                        <thead>
                            <tr>
                                <th>Grievance ID</th><th>Dept</th><th>Overdue By</th><th>System Diagnosis</th><th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% const escalated = grievances.filter(g => g.isEscalated && g.status !== 'RESOLVED'); %>
                            <% if(escalated.length > 0) { %>
                                <% escalated.forEach(g => { 
                                   const daysOld = Math.floor((new Date() - new Date(g.createdAt)) / (1000 * 60 * 60 * 24));
                                %>
                                <tr style="background-color: white;">
                                    <td><b><%= g.grievanceId %></b></td>
                                    <td><%= g.category %></td>
                                    <td class="text-danger fw-bold"><%= daysOld %> Days</td>
                                    <td class="text-muted small">Automatic Escalation: Unresolved for 20+ days</td>
                                    <td>
                                        <form action="/admin/resolve-escalation/<%= g._id %>" method="POST" class="d-flex gap-2">
                                            <input type="text" name="comment" class="form-control form-control-sm" placeholder="Resolution Note..." required>
                                            <button type="submit" class="sa-btn-view" style="background:#27ae60; color:white; border:none;">Resolve</button>
                                        </form>
                                    </td>
                                </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="5" class="text-center p-5">
                                        <div class="d-flex flex-column align-items-center justify-content-center text-muted">
                                            <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem; opacity: 0.5;"></i>
                                            <h6 class="fw-bold text-dark">All Systems Nominal</h6>
                                            <p class="small m-0">No critical escalations pending.</p>
                                        </div>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="sa-card mb-4">
                <div class="sa-card-title flex-wrap gap-3">
                    <div class="title-left-group"><span>Central Grievance Database</span></div> 
                    <div class="d-flex gap-2 ms-auto">
                        <div class="position-relative">
                            <input type="text" id="tableSearch" onkeyup="filterTable()" class="form-control rounded-pill ps-5" placeholder="Search Reference ID, Dept..." style="width: 250px; font-size: 0.85rem; border-color: var(--sa-border);">
                            <i class="fas fa-search position-absolute text-muted" style="left: 15px; top: 50%; transform: translateY(-50%); font-size: 0.8rem;"></i>
                        </div>
                        <button class="sa-btn-export shadow-sm" onclick="exportToExcel()">
                            <i class="fas fa-file-export me-2"></i>Export CSV
                        </button>
                    </div>
                </div>

                <div class="sa-table-wrapper">
                    <table class="sa-table" id="registryTable">
                        <thead>
                            <tr>
                                <th style="width: 60px;">S.No</th> <th>Reference ID</th>
                                <th>Department</th>
                                <th class="text-center">Date Logged</th>
                                <th class="text-center">Status</th>
                                <th class="text-end">Details</th>
                            </tr>
                        </thead>
                        <tbody id="grievanceTableBody">
                            <% grievances.forEach((g, index) => { %> 
                                <tr class="grievance-row">
                                    <td class="text-muted fw-bold"><%= index + 1 %></td> 
                                    <td class="fw-bold">
                                        <%= g.grievanceId %> 
                                        <% if(g.isEscalated) { %>
                                            <i class="fas fa-bolt text-danger ms-1" title="Escalated"></i>
                                        <% } %>
                                    </td>
                                    <td><%= g.category %></td>
                                    <td class="text-center"><%= new Date(g.createdAt).toLocaleDateString('en-IN') %></td>
                                    <td class="text-center"><span class="sa-badge <%= g.status.toLowerCase().replace('_', '-') %>"><%= g.status.replace('_', ' ') %></span></td>
                                    <td class="text-end"><a href="/admin/grievances/<%= g.grievanceId %>" class="sa-btn-view"><i class="fas fa-eye"></i> View</a></td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>

                <div class="pagination-container">
                    <span class="text-muted small">Showing <span id="startRow">1</span> to <span id="endRow">10</span> of <%= grievances.length %> entries</span>
                    <div class="d-flex gap-2">
                        <button class="pagination-btn" id="prevBtn" onclick="changePage(-1)">Previous</button>
                        <button class="pagination-btn" id="nextBtn" onclick="changePage(1)">Next</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="analytics-section" class="dashboard-section">
            <header class="sa-header">
                <div class="sa-header-left">
                    <h1 style="color: var(--sa-primary);">Data Visualization</h1>
                    <p>Deep dive into grievance data trends.</p>
                </div>
            </header>
            <div id="chartContainer" class="sa-charts-grid">
                <div class="sa-card">
                    <div class="sa-card-title"><div class="title-left-group"><i class="fas fa-chart-pie"></i><span>Departmental Load</span></div></div>
                    <div class="chart-container" style="height: 260px;"><canvas id="loadChart"></canvas></div>
                </div>
                <div class="sa-card">
                    <div class="sa-card-title"><div class="title-left-group"><i class="fas fa-tasks"></i><span>Status Distribution</span></div></div>
                    <div class="chart-container" style="height: 260px;"><canvas id="statusChart"></canvas></div>
                </div>
                <div class="sa-card full-column">
                    <div class="sa-card-title"><div class="title-left-group"><i class="fas fa-chart-line"></i><span>30-Day Submission Trend</span></div></div> 
                    <div class="chart-container" style="height: 320px;"><canvas id="trendChart"></canvas></div>
                </div>
                <div class="sa-card full-column">
                    <div class="sa-card-title"><div class="title-left-group"><i class="fas fa-chart-bar"></i><span>Resolution Efficiency</span></div></div>
                    <div class="chart-container" style="height: 380px;"><canvas id="performanceChart"></canvas></div>
                </div>
            </div>
        </div>

        <div id="accounts" class="dashboard-section">
            <header class="sa-header">
                <div class="sa-header-left"><h1>User Access Management</h1></div>
                <div class="sa-header-right"><a href="/admin/create-department" class="btn-provision-admin"><i class="fas fa-user-plus"></i>Provision New Admin</a></div>
            </header>
            <div class="sa-card">
                <div class="sa-card-title">Authorized Administrators</div>
                <div class="sa-table-wrapper">
                    <table class="sa-table">
                        <thead><tr><th>Name</th><th>Email</th><th class="text-center">Role</th><th class="text-end">Action</th></tr></thead>
                        <tbody>
                            <% if (departments && departments.length > 0) { %>
                                <% departments.sort((a, b) => (a.role === 'SUPERADMIN') ? -1 : 1).forEach(dept => { %>
                                    <tr style="<%= dept.role === 'SUPERADMIN' ? 'background-color: #f0f7ff;' : '' %>">
                                        <td class="fw-bold text-primary"><%= dept.name %></td>
                                        <td><%= dept.email %></td>
                                        <td class="text-center"><span class="badge <%= dept.role === 'SUPERADMIN' ? 'bg-danger' : 'bg-primary' %>"><%= dept.role %></span></td>
                                        <td class="text-end">
                                            <% if (dept.role === 'SUPERADMIN') { %>
                                                <span class="badge bg-secondary"><i class="fas fa-lock me-1"></i>SYSTEM PROTECTED</span>
                                            <% } else { %>
                                                <form action="/admin/accounts/<%= dept._id %>/delete" method="POST" onsubmit="return confirm('Account permanently delete karein?')">
                                                    <button class="btn btn-sm btn-light border text-danger"><i class="fas fa-trash-alt"></i> Delete</button>
                                                </form>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } else { %> <tr><td colspan="5" class="text-center text-muted p-4">No accounts detected.</td></tr> <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="audit" class="dashboard-section">
            <header class="sa-header"><h1>System Activity Logs</h1></header>
            <div class="sa-card">
                <div class="sa-card-title">Recent Event Ledger</div>
                <div class="audit-list">
                    <% grievances.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt)).slice(0, 15).forEach(g => { %>
                        <div class="audit-item border-bottom py-3 d-flex gap-3">
                            <i class="fas fa-fingerprint text-primary mt-1"></i>
                            <div>
                                <h6 class="m-0 fw-bold">Update on: <%= g.grievanceId %></h6>
                                <p class="small text-muted mb-1">State transitioned to <b><%= g.status %></b></p>
                                <small class="text-muted text-uppercase" style="font-size: 10px;"><%= new Date(g.updatedAt).toLocaleString() %></small>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    const rawGrievances = <%- JSON.stringify(grievances) %>;
    
    // --- PAGINATION LOGIC ---
    let currentPage = 1;
    const rowsPerPage = 8; // Number of rows to show at once

    function renderTable() {
        const table = document.getElementById("registryTable");
        const rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
        const totalRows = rows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);

        // Hide all rows first
        for (let i = 0; i < totalRows; i++) {
            rows[i].style.display = "none";
        }

        // Show current page rows
        let start = (currentPage - 1) * rowsPerPage;
        let end = start + rowsPerPage;
        let visibleCount = 0;

        for (let i = start; i < end && i < totalRows; i++) {
            rows[i].style.display = "";
            visibleCount++;
        }

        // Update Info Text
        document.getElementById("startRow").innerText = totalRows === 0 ? 0 : start + 1;
        document.getElementById("endRow").innerText = Math.min(end, totalRows);
        
        // Disable Buttons
        document.getElementById("prevBtn").disabled = currentPage === 1;
        document.getElementById("nextBtn").disabled = currentPage === totalPages || totalRows === 0;
    }

    function changePage(direction) {
        currentPage += direction;
        renderTable();
    }

    // --- OTHER FUNCTIONS ---
    function switchSection(id, btn) {
        document.querySelectorAll('.dashboard-section, .sa-nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        if (id === 'analytics-section') setTimeout(() => initCharts(rawGrievances), 100);
    }

    function toggleSLATable() {
        const toggle = document.getElementById('slaToggle');
        const container = document.getElementById('slaTableContainer');
        toggle.checked ? (container.classList.remove('d-none-custom'), container.classList.add('d-block-custom')) : (container.classList.remove('d-block-custom'), container.classList.add('d-none-custom'));
    }

    // UPDATED SEARCH (Strict: Only ID & Department)
    function filterTable() {
        let input = document.getElementById("tableSearch").value.toUpperCase().trim();
        let rows = document.getElementById("grievanceTableBody").getElementsByTagName("tr");
        
        if(input === "") {
            renderTable(); 
            return;
        }

        for (let i = 0; i < rows.length; i++) {
            // Column 1 is ID, Column 2 is Dept
            let col_ID  = rows[i].getElementsByTagName("td")[1].innerText.toUpperCase(); 
            let col_Dept = rows[i].getElementsByTagName("td")[2].innerText.toUpperCase(); 
            
            if (col_ID.indexOf(input) > -1 || col_Dept.indexOf(input) > -1) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
            }
        }
    }

    // UPDATED 30 DAY TREND
    function getTrendData(data) {
        const labels = [], counts = [];
        for (let i = 29; i >= 0; i--) { // Changed to 29 (30 days total)
            const d = new Date(); d.setDate(d.getDate() - i);
            labels.push(d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' }));
            counts.push(data.filter(g => new Date(g.createdAt).toDateString() === d.toDateString()).length);
        }
        return { labels, counts };
    }

    // CHARTS INIT
    let activeCharts = {};
    function initCharts(data = rawGrievances) {
        const chartCanvas = document.getElementById('loadChart');
        if(!chartCanvas || chartCanvas.offsetParent === null) return; 
        Object.values(activeCharts).forEach(c => c.destroy());
        const baseOpts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: '600', size: 10 }, padding: 15 } } } };
        const categories = [...new Set(data.map(g => g.category))];
        const qualitativePalette = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#8b5cf6', '#475569'];

        activeCharts.load = new Chart(document.getElementById('loadChart'), { type: 'doughnut', data: { labels: categories, datasets: [{ data: categories.map(c => data.filter(g => g.category === c).length), backgroundColor: qualitativePalette, borderWidth: 2, borderColor: '#fff' }] }, options: { ...baseOpts, cutout: '78%' } });
        activeCharts.status = new Chart(document.getElementById('statusChart'), { type: 'pie', data: { labels: ['Open', 'Review', 'Resolved'], datasets: [{ data: ['OPEN', 'UNDER_REVIEW', 'RESOLVED'].map(s => data.filter(g => g.status === s).length), backgroundColor: ['#f59e0b', '#6366f1', '#10b981', '#475569'], borderWidth: 2, borderColor: '#fff' }] }, options: baseOpts });
        
        const trend = getTrendData(data); // Will now use 30 days
        activeCharts.trend = new Chart(document.getElementById('trendChart'), { type: 'line', data: { labels: trend.labels, datasets: [{ label: 'Records', data: trend.counts, borderColor: '#003d82', backgroundColor: 'rgba(0, 61, 130, 0.08)', fill: true, tension: 0.4, pointRadius: 2, pointBackgroundColor: '#fff' }] }, options: { ...baseOpts, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { maxTicksLimit: 10 } }, y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { stepSize: 1 } } } } });
        
        activeCharts.perf = new Chart(document.getElementById('performanceChart'), { type: 'bar', data: { labels: categories, datasets: [{ label: 'Resolved', data: categories.map(c => data.filter(g => g.category === c && g.status === 'RESOLVED').length), backgroundColor: '#93c5fd', borderRadius: 4, barThickness: 45 }, { label: 'In Progress', data: categories.map(c => data.filter(g => g.category === c && g.status !== 'RESOLVED').length), backgroundColor: '#003d82', borderRadius: 4, barThickness: 45 }] }, options: { ...baseOpts, scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, beginAtZero: true, grid: { color: '#f1f5f9' } } } } });
    }

    document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        renderTable(); // Init pagination
    });
    // âœ… Export to CSV Function
    function exportToExcel() {
        const table = document.getElementById("registryTable"); // Registry Table 
        if (!table) return alert("Table not found!");

        let csv = [];
        const rows = table.querySelectorAll("tr");
        
        for (let i = 0; i < rows.length; i++) {
            if (rows[i].style.display !== "none") {
                const row = [], cols = rows[i].querySelectorAll("td, th");
                
                for (let j = 0; j < cols.length - 1; j++) {
                    let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, "").replace(/,/g, ";");
                    row.push(data);
                }
                csv.push(row.join(","));
            }
        }

        const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `AAI_Grievance_Report_${new Date().toLocaleDateString('en-IN')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>