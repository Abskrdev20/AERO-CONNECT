<% layout('layouts/boilerplate') -%>

<link rel="stylesheet" href="/css/super-admin.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="sa-container">
    <!-- SIDEBAR NAVIGATION -->
    <aside class="sa-sidebar">
        <div class="sa-profile">
            <div class="sa-avatar">SA</div>
            <h6 class="m-0 text-black">System Admin</h6>
            <small style="font-size: 0.9rem;">Command Center</small>
        </div>
        <nav class="sa-nav">
            <div class="sa-nav-item active" onclick="switchSection('intelligence', this)">
                <i class="fas fa-microchip"></i> <span>Global Intelligence</span>
            </div>
            <div class="sa-nav-item" onclick="switchSection('accounts', this)">
                <i class="fas fa-users-gear"></i> <span>Accounts Control</span>
            </div>
            <div class="sa-nav-item" onclick="switchSection('audit', this)">
                <i class="fas fa-shield-halved"></i> <span>Audit Trail</span>
            </div>
            <div class="sa-nav-divider"></div>
            <a href="/admin/create-department" class="sa-nav-item">
                <i class="fas fa-plus-circle"></i> <span>Add Account</span>
            </a>
            <a href="/logout" class="sa-nav-item sa-nav-logout">
                <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </a>
        </nav>
    </aside>

    <main class="sa-main">
        <!-- SECTION 1: GLOBAL INTELLIGENCE (ANALYTICS) -->
        <div id="intelligence" class="dashboard-section active">
            <header class="sa-header">
                <div class="sa-header-left">
                    <h1>Operational Intelligence</h1>
                    <p>Strategic monitoring across the AAI grievance network.</p>
                </div>
                <div class="sa-header-right">
                    <span class="badge bg-success border-0 px-4 py-2 rounded-pill shadow-sm d-inline-flex align-items-center gap-2" style="font-size: 0.7rem;">
                        <span class="spinner-grow spinner-grow-sm"></span>SYSTEM ACTIVE
                    </span>
                </div>
            </header>

            <!-- LIVE TICKER -->
            <div class="sa-ticker-container">
                <div class="ticker-wrapper">
                    <% for(let i = 0; i < 2; i++) { grievances.slice(0, 10).forEach(g => { %>
                        <span class="ticker-item">
                            <i class="fas fa-broadcast-tower me-2"></i>
                            ID: <b><%= g.grievanceId %></b> | SECTOR: <b><%= g.category %></b> | STATE: <b><%= g.status %></b>
                        </span>
                    <% }); } %>
                </div>
            </div>

            <!-- STATS GRID -->
            <div class="sa-stats-grid">
                <% const statData = [
                    {label: 'Gross Records', value: stats.total, color: 'var(--sa-accent)'},
                    {label: 'Verified Success', value: stats.resolved, color: 'var(--sa-success)', className: 'text-success'},
                    {label: 'Active Workflows', value: stats.pending, color: 'var(--sa-warning)'},
                    {label: 'Breach Alerts', value: stats.escalated, color: 'var(--sa-danger)', className: 'text-danger'}
                ]; statData.forEach(stat => { %>
                    <div class="sa-stat-card" style="border-top: 5px solid <%= stat.color %>;">
                        <span class="label"><%= stat.label %></span>
                        <span class="value <%= stat.className || '' %>"><%= stat.value %></span>
                    </div>
                <% }); %>
            </div>

            <!-- CHARTS VIEW -->
            <div id="chartView">
                <div class="chart-row">
                    <div class="sa-card">
                        <div class="sa-card-title">
                            <span>Sector Workload Distribution</span>
                            <i class="fas fa-chart-pie text-primary"></i>
                        </div>
                        <div class="chart-container"><canvas id="loadChart"></canvas></div>
                    </div>
                    <div class="sa-card">
                        <div class="sa-card-title">
                            <span>Protocol State Distribution</span>
                            <i class="fas fa-tasks text-info"></i>
                        </div>
                        <div class="chart-container"><canvas id="statusChart"></canvas></div>
                    </div>
                </div>
                <div class="chart-row-full">
                    <div class="sa-card">
                        <div class="sa-card-title">
                            <span>Sector Performance Matrix</span>
                            <i class="fas fa-chart-bar text-success"></i>
                        </div>
                        <div class="chart-container chart-container-tall"><canvas id="performanceChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- MASTER REGISTRY TABLE -->
            <div class="sa-card mb-4" id="archiveSection">
                <div class="sa-card-title">
                    <span>Master Grievance Registry Log</span>
                    <button class="sa-btn-export" onclick="exportToExcel()">
                        <i class="fas fa-file-export"></i> EXPORT REGISTRY
                    </button>
                </div>
                <div class="sa-table-wrapper">
                    <table class="sa-table" id="registryTable">
                        <thead>
                            <tr>
                                <th>Registry ID</th>
                                <th>Sector</th>
                                <th class="text-center">Submission Date</th>
                                <th class="text-center">Current State</th>
                                <th class="text-end">Log Access</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% grievances.forEach(g => { %>
                                <tr>
                                    <td><b><%= g.grievanceId %></b></td>
                                    <td><%= g.category %></td>
                                    <td class="text-center"><%= new Date(g.createdAt).toLocaleDateString('en-IN') %></td>
                                    <td class="text-center">
                                        <span class="sa-badge <%= g.status.toLowerCase().replace('_', '-') %>">
                                            <%= g.status.replace('_', ' ') %>
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <a href="/admin/grievances/<%= g.grievanceId %>" class="sa-btn-view">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SECTION 2: ACCOUNTS CONTROL (REAL-TIME) -->
        <div id="accounts" class="dashboard-section">
            <header class="sa-header">
                <div class="sa-header-left">
                    <h1>Identity & Access Control</h1>
                    <p>Manage administrative credentials and departmental access points.</p>
                </div>
                <div class="sa-header-right">
                    <a href="/admin/create-department" class="sa-btn-primary" style="text-decoration: none; padding: 12px 24px; background: var(--sa-primary); color: white; border-radius: 8px;">
                        <i class="fas fa-user-plus me-2"></i> Provision New Admin
                    </a>
                </div>
            </header>
            <div class="sa-card">
                <div class="sa-card-title">Active Administrator Directory</div>
                <div class="sa-table-wrapper">
                    <table class="sa-table">
                        <thead>
                            <tr>
                                <th>Department Name</th>
                                <th>Official Email</th>
                                <th class="text-center">Role Level</th>
                                <th class="text-center">System Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (typeof departments !== 'undefined' && departments && departments.length > 0) { %>
                                <% departments.forEach(dept => { %>
                                    <tr>
                                        <td><b><%= dept.name %></b></td>
                                        <td><%= dept.email %></td>
                                        <td class="text-center">
                                            <span class="badge <%= dept.role === 'SUPERADMIN' ? 'bg-danger' : 'bg-primary' %>">
                                                <%= dept.role %>
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="text-success fw-bold">
                                                <i class="fas fa-circle me-1" style="font-size: 8px;"></i> ONLINE
                                            </span>
                                        </td>
                                        <td class="text-end">
                                            <form action="/admin/accounts/<%= dept._id %>/delete" method="POST" onsubmit="return confirm('DANGER: Permanently delete this account?')" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-light border text-danger">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="5" class="text-center text-muted p-4">No accounts detected in database.</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SECTION 3: AUDIT TRAIL -->
        <div id="audit" class="dashboard-section">
            <header class="sa-header">
                <div class="sa-header-left">
                    <h1>System Audit Trail</h1>
                    <p>Immutable log of administrative decisions and security events.</p>
                </div>
            </header>
            <div class="sa-card">
                <div class="sa-card-title">Operational Event Ledger</div>
                <div class="audit-list" id="auditLogContainer">
                    <!-- Logs populated via JS -->
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    // Tab switching functionality
    function switchSection(id, btn) {
        document.querySelectorAll('.dashboard-section').forEach(section => section.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.sa-nav-item').forEach(item => item.classList.remove('active'));
        btn.classList.add('active');
    }

    // Pass server data to client script
    const deptLabels = <%- JSON.stringify(chartData.labels) %>;
    const rawGrievances = <%- JSON.stringify(grievances) %>;

    function initCharts() {
        const circularOpts = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } }
            }
        };

        // 1. Workload Doughnut
        new Chart(document.getElementById('loadChart'), {
            type: 'doughnut',
            data: {
                labels: deptLabels,
                datasets: [{
                    data: <%- JSON.stringify(chartData.counts) %>,
                    backgroundColor: ['#0f172a', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'],
                    borderWidth: 0
                }]
            },
            options: { ...circularOpts, cutout: '75%' }
        });

        // 2. Status Pie
        new Chart(document.getElementById('statusChart'), {
            type: 'pie',
            data: {
                labels: ['Open', 'Under Review', 'Resolved', 'Closed'],
                datasets: [{
                    data: [
                        rawGrievances.filter(g => g.status === 'OPEN').length,
                        rawGrievances.filter(g => g.status === 'UNDER_REVIEW').length,
                        rawGrievances.filter(g => g.status === 'RESOLVED').length,
                        rawGrievances.filter(g => g.status === 'CLOSED').length
                    ],
                    backgroundColor: ['#ef4444', '#3b82f6', '#10b981', '#94a3b8'],
                    borderWidth: 0
                }]
            },
            options: circularOpts
        });

        // 3. Performance Bar
        new Chart(document.getElementById('performanceChart'), {
            type: 'bar',
            data: {
                labels: deptLabels,
                datasets: [
                    {
                        label: 'Resolved',
                        data: deptLabels.map(l => rawGrievances.filter(g => g.category === l && g.status === 'RESOLVED').length),
                        backgroundColor: '#10b981',
                        borderRadius: 5
                    },
                    {
                        label: 'In Progress',
                        data: deptLabels.map(l => rawGrievances.filter(g => g.category === l && g.status !== 'RESOLVED').length),
                        backgroundColor: '#e2e8f0',
                        borderRadius: 5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { 
                    x: { stacked: true, grid: { display: false } }, 
                    y: { stacked: true, beginAtZero: true, grid: { color: '#f1f5f9' } } 
                }
            }
        });
    }

    function populateAuditLogs() {
        const container = document.getElementById('auditLogContainer');
        if (!container) return;
        container.innerHTML = rawGrievances.slice(0, 10).map(g => `
            <div class="audit-item">
                <div class="audit-icon"><i class="fas fa-history"></i></div>
                <div class="audit-info">
                    <h6>Workflow Update</h6>
                    <p>Grievance <b>${g.grievanceId}</b> moved to <b>${g.status}</b> state (Category: ${g.category}).</p>
                    <small class="text-muted">${new Date(g.updatedAt).toLocaleString()}</small>
                </div>
            </div>
        `).join('');
    }

    function exportToExcel() {
        const table = document.getElementById("registryTable");
        let csv = [];
        for (let i = 0; i < table.rows.length; i++) {
            let row = [], cols = table.rows[i].querySelectorAll("td, th");
            for (let j = 0; j < cols.length - 1; j++) row.push('"' + cols[j].innerText.trim() + '"');
            csv.push(row.join(","));
        }
        const blob = new Blob([csv.join("\n")], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `AAI_Registry_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    }

    document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        populateAuditLogs();
    });
</script>